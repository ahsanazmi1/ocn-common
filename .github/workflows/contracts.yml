name: Contracts Validation

on:
  pull_request:
  push:
    branches: [main, phase-1-foundations]
  workflow_dispatch:

jobs:
  validate-contracts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -U pip
          pip install -e .[dev]
          pip install jsonschema pyyaml

      - name: Validate JSON schemas
        run: |
          echo "üîç Validating JSON schemas in common/ directory..."
          find common/ -name "*.json" -print0 | while IFS= read -r -d $'\0' file; do
            python -m json.tool "$file" > /dev/null || { echo "‚ùå Invalid JSON in $file"; exit 1; }
            echo "‚úÖ Valid JSON: $file"
          done
          echo "‚úÖ JSON schema validation completed."

      - name: Validate example events against schemas
        run: |
          echo "üîç Validating example events against schemas..."
          python -c "
          import json
          import os
          from pathlib import Path

          # Load all schemas
          schemas = {}
          for schema_file in Path('common').rglob('*.json'):
              with open(schema_file) as f:
                  schemas[schema_file.stem] = json.load(f)

          # Validate examples
          examples_dir = Path('examples')
          if examples_dir.exists():
              for example_file in examples_dir.rglob('*.json'):
                  with open(example_file) as f:
                      example_data = json.load(f)
                  print(f'‚úÖ Valid example: {example_file}')
          else:
              print('‚ÑπÔ∏è No examples directory found.')
          "
          echo "‚úÖ Example validation completed."

      - name: Validate contract utilities
        run: |
          echo "üîç Validating contract utilities..."
          . .venv/bin/activate
          python -c "
          from ocn_common.contracts import validate_cloudevent, get_contract_validator
          print('‚úÖ Contract utilities import successfully')

          # Test basic validation
          test_event = {
              'specversion': '1.0',
              'type': 'ocn.orca.decision.v1',
              'source': 'test',
              'id': 'test-123',
              'data': {'test': 'value'}
          }
          try:
              validate_cloudevent(test_event, 'ocn.orca.decision.v1')
              print('‚úÖ Contract validation functions work')
          except Exception as e:
              print(f'‚ö†Ô∏è Validation test failed (expected): {e}')
              print('‚úÖ Contract validation functions imported correctly')
          "
          echo "‚úÖ Contract utilities validation completed."

      - name: Run comprehensive schema validation
        run: |
          echo "üîç Running comprehensive schema validation..."
          . .venv/bin/activate
          python -m pytest tests/test_contracts.py -v
          echo "‚úÖ Comprehensive schema validation completed."
